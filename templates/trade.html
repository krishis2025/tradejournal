{% extends "base.html" %}
{% block title %}Trade #{{ trade.id }} — {{ trade.date }}{% endblock %}

{% block extra_styles %}
.trade-hero {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 32px;
  align-items: start;
  margin-bottom: 32px;
}

.direction-badge {
  font-family: var(--font-display);
  font-size: 56px;
  letter-spacing: 4px;
  line-height: 1;
}
.direction-badge.long  { color: var(--green); text-shadow: 0 0 40px rgba(79,255,176,0.2); }
.direction-badge.short { color: var(--red);   text-shadow: 0 0 40px rgba(255,77,109,0.2); }

.fills-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 2px;
  overflow: hidden;
  margin-bottom: 24px;
}

.section-title {
  font-size: 9px; letter-spacing: 2.5px; text-transform: uppercase;
  color: var(--muted); margin-bottom: 14px;
  display: flex; align-items: center; gap: 10px;
}
.section-title::after { content:''; flex:1; height:1px; background:var(--border); }

.tag-section { margin-bottom: 24px; }

.tag-group-inline {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 2px;
  padding: 16px;
  margin-bottom: 12px;
}

.tg-label {
  font-size: 9px; letter-spacing: 2px; text-transform: uppercase;
  color: var(--muted); margin-bottom: 10px;
  display: flex; align-items: center; gap: 8px;
}
.tg-label::after { content:''; flex:1; height:1px; background:var(--border); }

.tags-row { display: flex; flex-wrap: wrap; gap: 6px; }

.tag-btn {
  background: var(--surface2);
  border: 1px solid var(--border2);
  color: var(--muted2);
  padding: 5px 12px;
  font-family: var(--font-mono);
  font-size: 11px;
  cursor: pointer;
  transition: all 0.12s;
  letter-spacing: 0.5px;
  clip-path: polygon(5px 0%, 100% 0%, calc(100% - 5px) 100%, 0% 100%);
}
.tag-btn:hover { background:var(--surface3); color:var(--text); border-color:var(--muted); }

.tag-btn.active-with    { background:rgba(79,255,176,0.12);  border-color:var(--green);  color:var(--green); }
.tag-btn.active-against { background:rgba(255,77,109,0.12); border-color:var(--red);    color:var(--red); }
.tag-btn.active-vol     { background:rgba(0,207,255,0.12);  border-color:var(--accent2);color:var(--accent2); }
.tag-btn.active-exit      { background:rgba(255,179,71,0.12); border-color:var(--warn);   color:var(--warn); }
.tag-btn.active-setup     { background:rgba(180,127,255,0.12);border-color:var(--purple); color:var(--purple); }
.tag-btn.active-pre       { background:rgba(138,150,170,0.15);border-color:var(--muted2); color:var(--text); }
.tag-btn.active-pre-good  { background:rgba(79,255,176,0.12); border-color:var(--green);  color:var(--green); }
.tag-btn.active-pre-bad   { background:rgba(255,77,109,0.12); border-color:var(--red);    color:var(--red); }
.tag-btn.active-exit-good { background:rgba(79,255,176,0.12); border-color:var(--green);  color:var(--green); }
.tag-btn.active-exit-bad  { background:rgba(255,77,109,0.12); border-color:var(--red);    color:var(--red); }
.tag-btn.active-vol-avg   { background:rgba(0,207,255,0.12);  border-color:var(--accent2);color:var(--accent2); }
.tag-btn.active-vol-high  { background:rgba(79,255,176,0.12); border-color:var(--green);  color:var(--green); }
.tag-btn.active-vol-low   { background:rgba(255,77,109,0.12); border-color:var(--red);    color:var(--red); }

.notes-area {
  width: 100%; background: var(--bg);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: var(--font-mono);
  font-size: 13px; padding: 14px 16px;
  resize: vertical; min-height: 120px;
  outline: none; transition: border-color 0.2s;
  line-height: 1.8; border-radius: 2px;
}
.notes-area:focus { border-color: var(--accent); }
.notes-area::placeholder { color: var(--border2); }

.nav-trades {
  display: flex; align-items: center; gap: 8px;
  font-size: 11px; color: var(--muted);
}
{% endblock %}

{% block nav_actions %}
<a href="/day/{{ trade.date }}" class="btn btn-ghost">← Day View</a>
<a href="/" class="btn btn-ghost">Dashboard</a>
{% endblock %}

{% block content %}

<div class="breadcrumb">
  <a href="/">Journal</a>
  <span class="sep">›</span>
  <a href="/day/{{ trade.date }}">{{ trade.date }}</a>
  <span class="sep">›</span>
  <span>Trade #{{ trade.trade_num }}</span>
</div>

{% set dir_cls = 'long' if trade.direction == 'Long' else 'short' %}
{% set pnl_cls = 'pnl-pos' if trade.pnl >= 0 else 'pnl-neg' %}

<div class="trade-hero">
  <div>
    <div style="display:flex; align-items:baseline; gap:20px; margin-bottom:8px;">
      <span class="direction-badge {{ dir_cls }}">{{ trade.direction }}</span>
      <span style="font-family:var(--font-display); font-size:28px; color:var(--muted); letter-spacing:2px;">
        T{{ trade.trade_num }}
      </span>
    </div>
    <div style="color:var(--muted2); font-size:12px; letter-spacing:1px;">
      {{ trade.date }} · {{ trade.entry_time }} → {{ trade.exit_time }} · {{ trade.qty }} MES
    </div>
  </div>

  <div class="stat-grid">
    <div class="stat-block">
      <div class="stat-label">Entry</div>
      <div class="stat-value" style="font-size:22px;">{{ '%.2f'|format(trade.avg_entry) }}</div>
    </div>
    <div class="stat-block">
      <div class="stat-label">Exit</div>
      <div class="stat-value" style="font-size:22px;">{{ '%.2f'|format(trade.avg_exit) }}</div>
    </div>
    <div class="stat-block">
      <div class="stat-label">P&L</div>
      <div class="stat-value {{ pnl_cls }}" style="font-size:28px;">
        {{ '+' if trade.pnl >= 0 else '' }}${{ '%.2f'|format(trade.pnl) }}
      </div>
    </div>
  </div>
</div>

<!-- Fills -->
<div class="fills-card">
  <div style="padding:16px 16px 0;">
    <div class="section-title">Fills ({{ trade.fills|length }})</div>
  </div>
  <table class="data-table">
    <thead>
      <tr>
        <th>Time</th><th>Side</th><th>Qty</th><th>Price</th><th>Type</th>
      </tr>
    </thead>
    <tbody>
      {% for f in trade.fills %}
      <tr>
        <td>{{ f.fill_time }}</td>
        <td class="{{ 'pnl-pos' if f.side == 'Buy' else 'pnl-neg' }}">{{ f.side }}</td>
        <td>{{ f.qty }}</td>
        <td>{{ '%.2f'|format(f.price) }}</td>
        <td style="font-size:10px;letter-spacing:0.5px;{% if f.exit_type == 'tp_hit' %}color:var(--green);{% elif f.exit_type == 'stop_hit' %}color:var(--red);{% elif f.exit_type == 'manual_exit' %}color:var(--warn);{% else %}color:var(--muted);{% endif %}">
          {% if f.exit_type == 'tp_hit' %}TP Hit{% elif f.exit_type == 'stop_hit' %}Stop Hit{% elif f.exit_type == 'manual_exit' %}Manual{% elif f.exit_type %}{{ f.exit_type }}{% else %}—{% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Execution Detail (from Live Trade) -->
{% if exec_detail %}
<div class="fills-card" style="margin-bottom:24px;">
  <div style="padding:16px 16px 0;">
    <div class="section-title">Execution Detail</div>
  </div>
  <div style="padding:0 16px 16px;">
    <!-- Position Map -->
    <table class="data-table" style="margin-bottom:12px;">
      <thead>
        <tr><th>Portion</th><th>Stop</th><th>Target</th><th>Qty</th></tr>
      </thead>
      <tbody>
        {% for lv in exec_detail.levels if lv.level_type == 'stop' %}
        {% set tp = None %}
        {% for t in exec_detail.levels if t.level_type == 'tp' and t.portion == lv.portion %}
          {% set tp = t %}
        {% endfor %}
        <tr>
          <td>P{{ lv.portion }}</td>
          <td style="color:var(--red);">{{ '%.2f'|format(lv.price) }}</td>
          <td style="color:var(--green);">{% for t in exec_detail.levels if t.level_type == 'tp' and t.portion == lv.portion %}{{ '%.2f'|format(t.price) }}{% endfor %}</td>
          <td>{{ lv.qty }}×</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Execution Log -->
    <div class="section-title" style="margin-top:12px;">Execution Log</div>
    <table class="data-table">
      <thead>
        <tr><th>Type</th><th>Portion</th><th>Qty</th><th>Price</th><th>Time</th><th>P&L</th></tr>
      </thead>
      <tbody>
        {% for e in exec_detail.executions %}
        <tr>
          <td style="font-size:10px;letter-spacing:0.5px;{% if e.exec_type == 'tp_hit' %}color:var(--green);{% elif e.exec_type == 'stop_hit' %}color:var(--red);{% elif e.exec_type == 'manual_exit' %}color:var(--warn);{% else %}color:var(--muted);{% endif %}">
            {% if e.exec_type == 'tp_hit' %}TP Hit{% elif e.exec_type == 'stop_hit' %}Stop Hit{% elif e.exec_type == 'manual_exit' %}Manual{% else %}{{ e.exec_type }}{% endif %}
          </td>
          <td>P{{ e.portion }}</td>
          <td>{{ e.qty }}×</td>
          <td>{{ '%.2f'|format(e.price) }}</td>
          <td>{{ e.exec_time }}</td>
          <td class="{{ 'pnl-pos' if e.pnl >= 0 else 'pnl-neg' }}">
            {{ '+' if e.pnl >= 0 else '' }}${{ '%.2f'|format(e.pnl) }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<!-- Tags -->
<div class="section-title">Trade Tags</div>

{% set dot_colors = {
  'dot-with':'#4fffb0','dot-against':'#ff4d6d','dot-vol':'#00cfff',
  'dot-exit':'#ffb347','dot-setup':'#b47fff','dot-pre':'#8a96aa','dot-entry':'#8a96aa'
} %}

<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
{% set EXIT_GOOD = ['Planned — Monitored Continuation'] %}
{% set VOL_MAP   = {'Avg':'active-vol-avg','Above Avg':'active-vol-high','Below Avg':'active-vol-low'} %}
{% for g in tag_groups[:4] %}
<div class="tag-group-inline">
  <div class="tg-label">
    <span style="width:6px;height:6px;border-radius:50%;background:{{ dot_colors[g.dot] }};flex-shrink:0;box-shadow:0 0 6px {{ dot_colors[g.dot] }}40;"></span>
    {{ g.label }}
  </div>
  <div class="tags-row" id="tags-{{ g.id }}">
    {% for tag in g.tags %}
    {% set is_active = tag in trade.tags.get(g.id, []) %}
    {% if g.id == 'exit' %}
      {% set active_cls = 'active-exit-good' if tag in EXIT_GOOD else 'active-exit-bad' %}
    {% elif g.id == 'volume' %}
      {% set active_cls = VOL_MAP.get(tag, g.active_class) %}
    {% else %}
      {% set active_cls = g.active_class %}
    {% endif %}
    <button
      class="tag-btn {{ active_cls if is_active else '' }}"
      data-tag="{{ tag }}"
      data-active-class="{{ active_cls }}"
      onclick="toggleTag('{{ g.id }}', '{{ tag }}', {{ 'true' if g.multi else 'false' }})">
      {{ tag }}
    </button>
    {% endfor %}
  </div>
</div>
{% endfor %}
</div>

<div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:32px;">
{% set PRE_GOOD = ['Trade came to me', 'Intuition / Mkt Feel'] %}
{% for g in tag_groups[4:] %}
<div class="tag-group-inline">
  <div class="tg-label">
    <span style="width:6px;height:6px;border-radius:50%;background:#8a96aa;flex-shrink:0;"></span>
    {{ g.label }}
  </div>
  <div class="tags-row" id="tags-{{ g.id }}">
    {% for tag in g.tags %}
    {% set is_active = tag in trade.tags.get(g.id, []) %}
    {% if g.id == 'pre' %}
      {% set active_cls = 'active-pre-good' if tag in PRE_GOOD else 'active-pre-bad' %}
    {% else %}
      {% set active_cls = g.active_class %}
    {% endif %}
    <button
      class="tag-btn {{ active_cls if is_active else '' }}"
      data-tag="{{ tag }}"
      data-active-class="{{ active_cls }}"
      onclick="toggleTag('{{ g.id }}', '{{ tag }}', {{ 'true' if g.multi else 'false' }})">
      {{ tag }}
    </button>
    {% endfor %}
  </div>
</div>
{% endfor %}
</div>

<!-- Notes -->
<div class="section-title">Notes</div>
<textarea class="notes-area"
  placeholder="Trade rationale, observations, market context, lessons learned..."
  oninput="scheduleNoteSave(this.value)">{{ trade.notes }}</textarea>
<div style="margin-top:6px; font-size:10px; color:var(--muted); letter-spacing:1px;" id="notes-status"></div>

{% endblock %}

{% block scripts %}
<script>
  const TRADE_ID  = {{ trade.id }};
  const TAG_GROUPS = {{ tags_json|safe }};

  async function toggleTag(groupId, tag, multi) {
    const container = document.getElementById('tags-' + groupId);
    const buttons   = container.querySelectorAll('.tag-btn');
    const group     = TAG_GROUPS.find(g => g.id === groupId);
    if (!group) return;

    // Per-button active class (pre-trade has good/bad split)
    const tagActiveClass = {};
    buttons.forEach(b => {
      tagActiveClass[b.dataset.tag] = b.dataset.activeClass || group.active_class;
    });

    const currentActive = new Set(
      [...buttons]
        .filter(b => b.classList.contains(tagActiveClass[b.dataset.tag]))
        .map(b => b.dataset.tag)
    );

    if (currentActive.has(tag)) {
      currentActive.delete(tag);
    } else {
      if (!multi) currentActive.clear();
      currentActive.add(tag);
    }

    buttons.forEach(btn => {
      const cls = tagActiveClass[btn.dataset.tag];
      btn.classList.toggle(cls, currentActive.has(btn.dataset.tag));
    });

    await fetch(`/api/trade/${TRADE_ID}/tags`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ group_id: groupId, tags: [...currentActive] })
    });
    showToast('Saved');
  }

  let noteTimer;
  function scheduleNoteSave(value) {
    document.getElementById('notes-status').textContent = 'Unsaved...';
    clearTimeout(noteTimer);
    noteTimer = setTimeout(() => saveNotes(value), 800);
  }

  async function saveNotes(notes) {
    await fetch(`/api/trade/${TRADE_ID}/notes`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ notes })
    });
    document.getElementById('notes-status').textContent = 'Saved ✓';
    setTimeout(() => document.getElementById('notes-status').textContent = '', 2000);
  }
</script>
{% endblock %}
