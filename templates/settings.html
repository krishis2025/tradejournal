{% extends "base.html" %}
{% block title %}Settings ‚Äî Trade Journal{% endblock %}

{% block extra_styles %}
/* Settings sidebar layout */
.settings-layout {
  display:grid; grid-template-columns:200px 1fr; gap:1px;
  background:var(--border); border:1px solid var(--border);
  min-height:calc(100vh - 180px);
}
.settings-sidebar {
  background:var(--surface); padding:0; position:sticky; top:0; align-self:start;
}
.settings-content {
  background:var(--surface); padding:28px 32px; overflow-y:auto;
}
.sidebar-item {
  display:flex; align-items:center; gap:10px; padding:14px 20px;
  font-family:var(--font-mono); font-size:11px; letter-spacing:1.5px;
  text-transform:uppercase; color:var(--muted2); cursor:pointer;
  border-bottom:1px solid var(--border); border-left:3px solid transparent;
  transition:all 0.12s; background:transparent;
}
.sidebar-item:hover { background:var(--surface2); color:var(--text); }
.sidebar-item.active {
  color:var(--accent); background:var(--surface2);
  border-left-color:var(--accent);
}
.sidebar-icon { font-size:14px; width:20px; text-align:center; }
.settings-section { display:none; }
.settings-section.active { display:block; }
.settings-section-title {
  font-family:var(--font-display); font-size:24px; letter-spacing:3px;
  color:var(--text); margin-bottom:6px;
}
.settings-section-sub {
  font-size:11px; color:var(--muted); letter-spacing:1px; margin-bottom:24px;
}

.settings-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 32px;
}

.tag-config-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 2px;
  overflow: hidden;
}

.tag-config-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 18px;
  border-bottom: 1px solid var(--border);
  background: var(--surface2);
}

.tag-config-title {
  display: flex; align-items: center; gap: 10px;
  font-family: var(--font-display);
  font-size: 17px; letter-spacing: 2px;
}

.tg-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }

.tag-config-body { padding: 16px 18px; }

/* Tag list - editable chips */
.tag-list {
  display: flex; flex-direction: column; gap: 6px;
  margin-bottom: 12px;
  min-height: 40px;
}

.tag-item {
  display: flex; align-items: center; gap: 8px;
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: 1px;
  padding: 6px 10px;
  cursor: grab;
  transition: background 0.12s, border-color 0.12s;
  user-select: none;
}
.tag-item:hover { background: var(--surface3); border-color: var(--muted); }
.tag-item.dragging { opacity: 0.4; cursor: grabbing; }
.tag-item.drag-over { border-color: var(--accent); background: rgba(79,255,176,0.06); }

.tag-item-handle {
  color: var(--border2); font-size: 12px; cursor: grab; flex-shrink: 0;
  transition: color 0.12s;
}
.tag-item:hover .tag-item-handle { color: var(--muted); }

.tag-item-text {
  flex: 1;
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text);
  background: transparent;
  border: none;
  outline: none;
  padding: 0;
  width: 100%;
}
.tag-item-text:focus { color: var(--accent); }

.tag-item-del {
  color: var(--muted); font-size: 13px; cursor: pointer;
  transition: color 0.12s; flex-shrink: 0; background: none; border: none;
  padding: 0; line-height: 1;
}
.tag-item-del:hover { color: var(--red); }

/* Add tag row */
.add-tag-row {
  display: flex; gap: 6px; align-items: center;
}
.add-tag-input {
  flex: 1;
  background: var(--bg);
  border: 1px dashed var(--border2);
  color: var(--text);
  padding: 6px 10px;
  font-family: var(--font-mono);
  font-size: 11px;
  border-radius: 1px;
  outline: none;
  transition: border-color 0.15s;
}
.add-tag-input:focus { border-color: var(--accent); border-style: solid; }
.add-tag-input::placeholder { color: var(--border2); }

.add-tag-btn {
  background: var(--surface3);
  border: 1px solid var(--border2);
  color: var(--muted2);
  padding: 6px 12px;
  font-family: var(--font-mono);
  font-size: 11px; letter-spacing: 1px;
  cursor: pointer; border-radius: 1px;
  transition: all 0.12s; white-space: nowrap;
}
.add-tag-btn:hover { color: var(--accent); border-color: var(--accent); }

/* Card footer */
.tag-config-footer {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 18px;
  border-top: 1px solid var(--border);
  background: var(--surface2);
}

.save-status {
  font-size: 10px; letter-spacing: 1px;
  color: var(--muted); transition: color 0.3s;
}
.save-status.saved  { color: var(--green); }
.save-status.saving { color: var(--warn); }
.save-status.error  { color: var(--red); }

.reset-btn {
  background: transparent; border: none;
  color: var(--muted); font-family: var(--font-mono);
  font-size: 10px; letter-spacing: 1px;
  cursor: pointer; transition: color 0.12s;
  padding: 0;
}
.reset-btn:hover { color: var(--warn); }

/* Multi section toggle */
.multi-toggle {
  display: flex; align-items: center; gap: 6px;
  font-size: 10px; color: var(--muted); letter-spacing: 1px;
}
.toggle-switch {
  width: 28px; height: 16px;
  background: var(--border2); border-radius: 8px;
  cursor: pointer; position: relative;
  transition: background 0.2s;
}
.toggle-switch.on { background: var(--accent); }
.toggle-switch::after {
  content: ''; position: absolute;
  width: 12px; height: 12px;
  background: #fff; border-radius: 50%;
  top: 2px; left: 2px;
  transition: left 0.2s;
}
.toggle-switch.on::after { left: 14px; }

/* Theme Picker */
.theme-section {
  margin-bottom:28px;
}
.theme-section-title {
  font-family:var(--font-display); font-size:17px; letter-spacing:2px;
  color:var(--muted2); margin-bottom:12px; display:flex; align-items:center; gap:10px;
}
.theme-section-title::after { content:''; flex:1; height:1px; background:var(--border); }

.theme-grid {
  display:grid; grid-template-columns:repeat(3, 1fr); gap:10px;
}
.theme-card {
  background:var(--surface); border:2px solid var(--border); border-radius:2px;
  padding:0; cursor:pointer; transition:all 0.15s; overflow:hidden;
  position:relative;
}
.theme-card:hover { border-color:var(--muted); transform:translateY(-1px); }
.theme-card.active { border-color:var(--accent); box-shadow:0 0 12px var(--accent-glow); }
.theme-card.active::after {
  content:'‚úì'; position:absolute; top:8px; right:10px;
  font-size:14px; color:var(--accent);
}

.theme-preview {
  height:48px; display:flex; align-items:stretch; gap:1px; padding:6px;
}
.tp-swatch {
  flex:1; border-radius:1px;
}

.theme-label {
  padding:8px 12px; display:flex; align-items:center; gap:8px;
  font-size:11px; color:var(--text); letter-spacing:0.5px;
  border-top:1px solid var(--border);
}
.theme-label-icon { font-size:13px; }
.theme-label-name { font-family:var(--font-mono); }
.info-banner {
  background: rgba(0,207,255,0.05);
  border: 1px solid rgba(0,207,255,0.2);
  border-radius: 2px;
  padding: 14px 20px;
  margin-bottom: 28px;
  font-size: 12px; color: var(--muted2); line-height: 1.6;
  display: flex; gap: 12px; align-items: flex-start;
}
.info-icon { color: var(--accent2); flex-shrink: 0; font-size: 16px; }

/* DB Admin panel */
.db-admin-bar {
  display: flex; align-items: center; justify-content: space-between;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 2px; padding: 14px 20px; margin-bottom: 16px;
}
.db-admin-label {
  display: flex; align-items: center; gap: 12px;
}
.db-admin-title {
  font-family: var(--font-mono); font-size: 12px; letter-spacing: 1.5px;
  text-transform: uppercase; color: var(--muted2);
}
.db-admin-sub {
  font-size: 10px; color: var(--muted); letter-spacing: 0.5px; margin-top: 2px;
}
.db-admin-icon { font-size: 18px; opacity: 0.6; }

.db-admin-panel {
  background: var(--surface);
  border: 1px solid var(--border2);
  border-top: 3px solid var(--warn);
  border-radius: 2px;
  padding: 24px;
  margin-bottom: 28px;
  display: none;
}
.db-admin-panel.visible { display: block; }

.db-admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

.db-action-card {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 2px; padding: 20px;
}
.db-action-title {
  font-family: var(--font-display); font-size: 15px; letter-spacing: 2px;
  color: var(--text); margin-bottom: 6px;
}
.db-action-desc {
  font-size: 11px; color: var(--muted); line-height: 1.6; margin-bottom: 16px;
}
.db-action-desc code {
  font-family: var(--font-mono); color: var(--accent2);
  background: var(--bg); padding: 1px 5px; border-radius: 2px;
}
.db-file-input { display: none; }
.db-import-label {
  display: inline-flex; align-items: center; gap: 6px;
  background: var(--surface3); border: 1px solid var(--border2);
  color: var(--muted2); padding: 7px 14px;
  font-family: var(--font-mono); font-size: 10px; letter-spacing: 1px;
  cursor: pointer; border-radius: 1px; transition: all 0.15s;
}
.db-import-label:hover { color: var(--text); border-color: var(--muted); }
.db-import-status {
  margin-top: 10px; font-size: 11px; font-family: var(--font-mono);
  color: var(--muted); min-height: 18px;
}
.db-import-status.ok  { color: var(--green); }
.db-import-status.err { color: var(--red); }
{% endblock %}

{% block nav_actions %}
<a href="/" class="btn btn-ghost">‚Üê Dashboard</a>
{% endblock %}

{% block content %}

<div style="display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:20px;">
  <div>
    <div class="page-title">Settings</div>
  </div>
  <button class="btn btn-primary" onclick="saveAll()">Save All Changes</button>
</div>

<div class="settings-layout">
  <!-- ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ -->
  <div class="settings-sidebar">
    <div class="sidebar-item active" onclick="showSection('tags',this)">
      <span class="sidebar-icon">üè∑</span> Tags
    </div>
    <div class="sidebar-item" onclick="showSection('db',this)">
      <span class="sidebar-icon">üóÑ</span> DB Admin
    </div>
    <div class="sidebar-item" onclick="showSection('live',this)">
      <span class="sidebar-icon">‚ö°</span> Live Trade
    </div>
    <div class="sidebar-item" onclick="showSection('theme',this)">
      <span class="sidebar-icon">üé®</span> Theme
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Content Area ‚îÄ‚îÄ -->
  <div class="settings-content">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAGS SECTION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="settings-section active" id="section-tags">
      <div class="settings-section-title">Tags</div>
      <div class="settings-section-sub">Edit, reorder (drag), or add tags for each section. Click Reset to restore defaults.</div>

      <div class="settings-grid" id="settings-grid">
        {% set dot_colors = {
          'dot-with':'#4fffb0','dot-against':'#ff4d6d','dot-vol':'#00cfff',
          'dot-exit':'#ffb347','dot-setup':'#b47fff','dot-pre':'#8a96aa','dot-entry':'#8a96aa'
        } %}

        {% for g in tag_groups %}
        <div class="tag-config-card" id="card-{{ g.id }}" data-group="{{ g.id }}" data-multi="{{ 'true' if g.multi else 'false' }}">
          <div class="tag-config-header">
            <div class="tag-config-title">
              <span class="tg-dot" style="background:{{ dot_colors[g.dot] }};box-shadow:0 0 8px {{ dot_colors[g.dot] }}50;"></span>
              {{ g.label }}
              <span style="font-size:11px;color:var(--muted);font-family:var(--font-mono);font-weight:400;letter-spacing:1px;">
                ({{ g.tags|length }} tags)
              </span>
            </div>
            <div class="multi-toggle">
              <span>Multi-select</span>
              <div class="toggle-switch {{ 'on' if g.multi else '' }}" id="multi-{{ g.id }}"
                onclick="toggleMulti('{{ g.id }}', this)"></div>
            </div>
          </div>

          <div class="tag-config-body">
            <div class="tag-list" id="list-{{ g.id }}" 
                 ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event, '{{ g.id }}')">
              {% for tag in g.tags %}
              <div class="tag-item" draggable="true"
                   ondragstart="onDragStart(event, '{{ g.id }}')"
                   ondragend="onDragEnd(event)">
                <span class="tag-item-handle">‚†ø</span>
                <input class="tag-item-text" type="text" value="{{ tag }}"
                       oninput="markDirty('{{ g.id }}')">
                <button class="tag-item-del" onclick="removeTag(this)" title="Remove tag">‚úï</button>
              </div>
              {% endfor %}
            </div>

            <div class="add-tag-row">
              <input class="add-tag-input" type="text" placeholder="Add new tag..."
                     id="add-input-{{ g.id }}"
                     onkeydown="if(event.key==='Enter') addTag('{{ g.id }}')">
              <button class="add-tag-btn" onclick="addTag('{{ g.id }}')">+ Add</button>
            </div>
          </div>

          <div class="tag-config-footer">
            <span class="save-status" id="status-{{ g.id }}">‚Äî</span>
            <div style="display:flex;gap:12px;align-items:center;">
              <button class="reset-btn" onclick="resetGroup('{{ g.id }}')">‚Ü∫ Reset to defaults</button>
              <button class="btn btn-ghost" style="padding:5px 14px;font-size:10px;"
                      onclick="saveGroup('{{ g.id }}')">Save</button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DB ADMIN SECTION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="settings-section" id="section-db">
      <div class="settings-section-title">DB Admin</div>
      <div class="settings-section-sub">Export &amp; import your database for backup / restore / sync between machines</div>

      <div style="display:flex;align-items:center;gap:10px;margin-bottom:18px;">
        <span style="font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--warn);">‚ö† Caution</span>
        <span style="font-size:10px;color:var(--muted);">Always export before importing. Import overwrites all current data.</span>
      </div>
      <div class="db-admin-grid">
        <!-- Export -->
        <div class="db-action-card">
          <div class="db-action-title">Export SQL</div>
          <div class="db-action-desc">
            Downloads your entire database as a <code>.sql</code> text file ‚Äî
            all trades, fills, tags, notes, screenshots, portfolios and settings.
            Safe to keep as a backup before any code update.
          </div>
          <button class="btn btn-ghost" style="padding:7px 18px;font-size:10px;letter-spacing:1px;"
                  onclick="exportDb()">‚¨á Download backup .sql</button>
        </div>

        <!-- Import -->
        <div class="db-action-card">
          <div class="db-action-title">Import SQL</div>
          <div class="db-action-desc">
            Restores a previously exported <code>.sql</code> file.
            <strong style="color:var(--warn);">Overwrites all current data.</strong>
            A <code>.bak</code> of the current database is auto-saved before import.
          </div>
          <label class="db-import-label">
            ‚¨Ü Choose .sql file to restore
            <input type="file" class="db-file-input" id="db-import-input"
                   accept=".sql" onchange="importDb(this)">
          </label>
          <div class="db-import-status" id="db-import-status"></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LIVE TRADE CONFIG SECTION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="settings-section" id="section-live">
      <div class="settings-section-title">Live Trade Config</div>
      <div class="settings-section-sub">Instrument tick values &amp; default stop/target distances</div>

      <!-- Instrument Config -->
      <div class="settings-grid" style="margin-bottom:24px;">
        {% for inst_name, inst in instrument_config.items() %}
        <div class="tag-config-card">
          <div class="tag-config-header">
            <div class="tag-config-title">
              <span class="tg-dot" style="background:{{ 'var(--green)' if inst_name == 'MES' else 'var(--accent2)' }};"></span>
              {{ inst_name }}
            </div>
          </div>
          <div class="tag-config-body">
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
              <div>
                <label style="display:block;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;">$/Point</label>
                <input type="number" step="0.01" class="add-tag-input" style="width:100%;padding:6px 8px;"
                       id="inst-{{ inst_name }}-dpp" value="{{ inst.dollars_per_point }}">
              </div>
              <div>
                <label style="display:block;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;">$/Tick</label>
                <input type="number" step="0.01" class="add-tag-input" style="width:100%;padding:6px 8px;"
                       id="inst-{{ inst_name }}-dpt" value="{{ inst.dollars_per_tick }}">
              </div>
              <div>
                <label style="display:block;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;">Ticks/Point</label>
                <input type="number" step="1" class="add-tag-input" style="width:100%;padding:6px 8px;"
                       id="inst-{{ inst_name }}-tpp" value="{{ inst.ticks_per_point }}">
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Trade Defaults -->
      <div class="tag-config-card" style="margin-bottom:24px;">
        <div class="tag-config-header">
          <div class="tag-config-title">
            <span class="tg-dot" style="background:var(--warn);"></span>
            Default Stop &amp; Target Distances (points)
          </div>
        </div>
        <div class="tag-config-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
            <!-- Full mode -->
            <div>
              <div style="font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:12px;border-bottom:1px solid var(--border);padding-bottom:6px;">Full Position Mode</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                <div>
                  <label style="display:block;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;">Stop (pts)</label>
                  <input type="number" step="0.25" class="add-tag-input" style="width:100%;padding:6px 8px;"
                         id="td-full_stop_points" value="{{ trade_defaults.full_stop_points }}">
                </div>
                <div>
                  <label style="display:block;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;">Target (pts)</label>
                  <input type="number" step="0.25" class="add-tag-input" style="width:100%;padding:6px 8px;"
                         id="td-full_tp_points" value="{{ trade_defaults.full_tp_points }}">
                </div>
              </div>
            </div>
            <!-- Partials mode -->
            <div>
              <div style="font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:12px;border-bottom:1px solid var(--border);padding-bottom:6px;">Partials Mode (3-way split)</div>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;">
                <div>
                  <label style="display:block;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;">Stop (pts)</label>
                  <input type="number" step="0.25" class="add-tag-input" style="width:100%;padding:6px 8px;"
                         id="td-partial_stop_points" value="{{ trade_defaults.partial_stop_points }}">
                </div>
                <div>
                  <label style="display:block;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;">TP1 (pts)</label>
                  <input type="number" step="0.25" class="add-tag-input" style="width:100%;padding:6px 8px;"
                         id="td-partial_tp1_points" value="{{ trade_defaults.partial_tp1_points }}">
                </div>
                <div>
                  <label style="display:block;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;">TP2 (pts)</label>
                  <input type="number" step="0.25" class="add-tag-input" style="width:100%;padding:6px 8px;"
                         id="td-partial_tp2_points" value="{{ trade_defaults.partial_tp2_points }}">
                </div>
                <div>
                  <label style="display:block;font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;">TP3 (pts)</label>
                  <input type="number" step="0.25" class="add-tag-input" style="width:100%;padding:6px 8px;"
                         id="td-partial_tp3_points" value="{{ trade_defaults.partial_tp3_points }}">
                </div>
              </div>
            </div>
          </div>
          <div style="margin-top:16px;text-align:right;">
            <button class="btn btn-primary" style="padding:7px 18px;font-size:10px;" onclick="saveLiveConfig()">Save Live Trade Config</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê THEME SECTION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="settings-section" id="section-theme">
      <div class="settings-section-title">Theme</div>
      <div class="settings-section-sub">Choose a color theme for your journal</div>
      <div class="theme-grid" id="theme-grid"></div>
    </div>

  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  const DEFAULTS = {{ defaults_json|safe }};
  const dirty    = new Set();

  // ‚îÄ‚îÄ Drag & Drop Reorder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let dragSrc = null;

  function onDragStart(e, groupId) {
    dragSrc = e.currentTarget;
    dragSrc.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
  }

  function onDragEnd(e) {
    document.querySelectorAll('.tag-item').forEach(el => {
      el.classList.remove('dragging', 'drag-over');
    });
    dragSrc = null;
  }

  function onDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    const target = e.target.closest('.tag-item');
    if (target && target !== dragSrc) {
      document.querySelectorAll('.tag-item').forEach(el => el.classList.remove('drag-over'));
      target.classList.add('drag-over');
    }
  }

  function onDragLeave(e) {
    const target = e.target.closest('.tag-item');
    if (target) target.classList.remove('drag-over');
  }

  function onDrop(e, groupId) {
    e.preventDefault();
    const target = e.target.closest('.tag-item');
    if (!target || target === dragSrc) return;
    target.classList.remove('drag-over');

    const list = document.getElementById('list-' + groupId);
    const items = [...list.querySelectorAll('.tag-item')];
    const srcIdx = items.indexOf(dragSrc);
    const tgtIdx = items.indexOf(target);

    if (srcIdx < tgtIdx) {
      target.parentNode.insertBefore(dragSrc, target.nextSibling);
    } else {
      target.parentNode.insertBefore(dragSrc, target);
    }

    markDirty(groupId);
  }

  // ‚îÄ‚îÄ Tag Mutations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function addTag(groupId) {
    const input = document.getElementById('add-input-' + groupId);
    const val   = input.value.trim();
    if (!val) return;

    const list = document.getElementById('list-' + groupId);
    const item = buildTagItem(val, groupId);
    list.appendChild(item);
    input.value = '';
    markDirty(groupId);
    input.focus();
  }

  function removeTag(btn) {
    const item    = btn.closest('.tag-item');
    const groupId = item.closest('.tag-config-card').dataset.group;
    item.remove();
    markDirty(groupId);
  }

  function buildTagItem(tag, groupId) {
    const div = document.createElement('div');
    div.className = 'tag-item';
    div.draggable = true;
    div.ondragstart = e => onDragStart(e, groupId);
    div.ondragend   = onDragEnd;
    div.innerHTML = `
      <span class="tag-item-handle">‚†ø</span>
      <input class="tag-item-text" type="text" value="${tag.replace(/"/g,'&quot;')}"
             oninput="markDirty('${groupId}')">
      <button class="tag-item-del" onclick="removeTag(this)" title="Remove tag">‚úï</button>
    `;
    return div;
  }

  // ‚îÄ‚îÄ Multi-select toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function toggleMulti(groupId, el) {
    el.classList.toggle('on');
    markDirty(groupId);
  }

  // ‚îÄ‚îÄ Dirty tracking ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function markDirty(groupId) {
    dirty.add(groupId);
    setStatus(groupId, 'Unsaved', 'saving');
  }

  function setStatus(groupId, msg, cls) {
    const el = document.getElementById('status-' + groupId);
    el.textContent = msg;
    el.className   = 'save-status ' + (cls || '');
  }

  // ‚îÄ‚îÄ Read current tags from DOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function getTagsFromDOM(groupId) {
    const list = document.getElementById('list-' + groupId);
    return [...list.querySelectorAll('.tag-item-text')]
      .map(i => i.value.trim())
      .filter(Boolean);
  }

  // ‚îÄ‚îÄ Save ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function saveGroup(groupId) {
    const tags = getTagsFromDOM(groupId);
    setStatus(groupId, 'Saving‚Ä¶', 'saving');
    try {
      const res = await fetch(`/api/settings/tags/${groupId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ tags })
      });
      if (res.ok) {
        dirty.delete(groupId);
        setStatus(groupId, '‚úì Saved', 'saved');
        setTimeout(() => setStatus(groupId, '‚Äî', ''), 2500);
      } else {
        setStatus(groupId, '‚úó Error', 'error');
      }
    } catch(e) {
      setStatus(groupId, '‚úó Network error', 'error');
    }
  }

  async function saveAll() {
    const cards = document.querySelectorAll('.tag-config-card');
    const promises = [...cards].map(card => saveGroup(card.dataset.group));
    await Promise.all(promises);
    showToast('All sections saved');
  }

  // ‚îÄ‚îÄ Reset ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function resetGroup(groupId) {
    try {
      const res  = await fetch(`/api/settings/tags/${groupId}/reset`, { method: 'POST' });
      const data = await res.json();
      if (!res.ok) { showToast('Reset failed', true); return; }

      // Rebuild the tag list from defaults
      const list = document.getElementById('list-' + groupId);
      list.innerHTML = '';
      (data.tags || []).forEach(tag => list.appendChild(buildTagItem(tag, groupId)));

      // Reset multi toggle to default
      const defGroup = DEFAULTS.find(g => g.id === groupId);
      const toggle   = document.getElementById('multi-' + groupId);
      if (defGroup && toggle) {
        toggle.classList.toggle('on', defGroup.multi);
      }

      dirty.delete(groupId);
      setStatus(groupId, '‚úì Reset', 'saved');
      setTimeout(() => setStatus(groupId, '‚Äî', ''), 2500);
      showToast(`${groupId} reset to defaults`);
    } catch(e) {
      showToast('Reset failed', true);
    }
  }

  // ‚îÄ‚îÄ Warn on leaving with unsaved changes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  window.addEventListener('beforeunload', e => {
    if (dirty.size > 0) {
      e.preventDefault();
      e.returnValue = '';
    }
  });

  // ‚îÄ‚îÄ Sidebar section switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showSection(id, el) {
    document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.sidebar-item').forEach(s => s.classList.remove('active'));
    document.getElementById('section-' + id).classList.add('active');
    el.classList.add('active');
  }

  // ‚îÄ‚îÄ Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function exportDb() {
    // Simple link click ‚Äî browser handles the file download
    const a = document.createElement('a');
    a.href = '/api/db/export';
    a.download = 'tradejournal_backup.sql';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    showToast('Backup downloaded ‚úì');
  }

  // ‚îÄ‚îÄ Import ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function importDb(input) {
    const file = input.files[0];
    if (!file) return;
    const status = document.getElementById('db-import-status');
    status.className = 'db-import-status';
    status.textContent = 'Uploading‚Ä¶';

    const form = new FormData();
    form.append('file', file);

    try {
      const res  = await fetch('/api/db/import', { method: 'POST', body: form });
      const data = await res.json();
      if (res.ok) {
        status.className = 'db-import-status ok';
        status.textContent = '‚úì ' + data.message + ' Reloading‚Ä¶';
        showToast('Database restored ‚Äî reloading');
        setTimeout(() => location.reload(), 1800);
      } else {
        status.className = 'db-import-status err';
        status.textContent = '‚úó ' + (data.error || 'Import failed');
      }
    } catch(e) {
      status.className = 'db-import-status err';
      status.textContent = '‚úó Network error';
    }
    // Reset input so same file can be re-selected if needed
    input.value = '';
  }

  // ‚îÄ‚îÄ Save Live Trade Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function saveLiveConfig() {
    // Instrument config
    const instruments = {};
    ['MES', 'ES'].forEach(inst => {
      instruments[inst] = {
        dollars_per_point: parseFloat(document.getElementById(`inst-${inst}-dpp`).value),
        dollars_per_tick:  parseFloat(document.getElementById(`inst-${inst}-dpt`).value),
        ticks_per_point:   parseInt(document.getElementById(`inst-${inst}-tpp`).value),
      };
    });

    // Trade defaults
    const defaults = {};
    ['full_stop_points','full_tp_points','partial_stop_points',
     'partial_tp1_points','partial_tp2_points','partial_tp3_points'].forEach(key => {
      defaults[key] = document.getElementById('td-' + key).value;
    });

    try {
      await fetch('/api/settings/instruments', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(instruments)
      });
      await fetch('/api/settings/trade-defaults', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(defaults)
      });
      showToast('Live trade config saved ‚úì');
    } catch(e) {
      showToast('Error saving config', true);
    }
  }

  // ‚îÄ‚îÄ Theme Picker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  (function buildThemeGrid() {
    const grid = document.getElementById('theme-grid');
    if (!grid) return;
    const current = getCurrentTheme();

    for (const [id, theme] of Object.entries(TJ_THEMES)) {
      const v = theme.vars;
      const card = document.createElement('div');
      card.className = 'theme-card' + (id === current ? ' active' : '');
      card.dataset.theme = id;
      card.onclick = () => {
        setTheme(id);
        grid.querySelectorAll('.theme-card').forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        showToast(theme.name + ' applied');
      };

      // Preview swatches: bg, surface, accent, accent2, green, red
      card.innerHTML = `
        <div class="theme-preview" style="background:${v['--bg']};">
          <div class="tp-swatch" style="background:${v['--surface']};"></div>
          <div class="tp-swatch" style="background:${v['--surface2']};"></div>
          <div class="tp-swatch" style="background:${v['--accent']};"></div>
          <div class="tp-swatch" style="background:${v['--accent2']};"></div>
          <div class="tp-swatch" style="background:${v['--green']};"></div>
          <div class="tp-swatch" style="background:${v['--red']};"></div>
        </div>
        <div class="theme-label">
          <span class="theme-label-icon">${theme.icon}</span>
          <span class="theme-label-name">${theme.name}</span>
        </div>
      `;
      grid.appendChild(card);
    }
  })();

</script>
{% endblock %}
