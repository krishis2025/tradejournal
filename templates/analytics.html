{% extends "base.html" %}
{% block title %}Analytics â€” Trade Journal{% endblock %}

{% block extra_styles %}
/* â”€â”€ Analytics Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chart-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 2px;
  padding: 22px 24px;
}
.chart-title {
  font-family: var(--font-display);
  font-size: 17px; letter-spacing: 2px;
  color: var(--text); margin-bottom: 3px;
}
.chart-sub {
  font-size: 10px; color: var(--muted);
  letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 18px;
}

.chart-box { position: relative; width: 100%; }
.chart-box-180 { height: 180px; }
.chart-box-220 { height: 220px; }
.chart-box-260 { height: 260px; }
.chart-box-300 { height: 300px; }

.analytics-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
.analytics-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }

.section-divider {
  font-family: var(--font-display); font-size: 14px; letter-spacing: 3px;
  text-transform: uppercase; color: var(--muted); margin: 32px 0 16px;
  padding-bottom: 8px; border-bottom: 1px solid var(--border);
}

/* â”€â”€ Date Filter Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.date-filter-bar {
  display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
  margin-bottom: 24px; padding: 14px 18px;
  background: var(--surface); border: 1px solid var(--border); border-radius: 2px;
}
.date-filter-label {
  font-size: 9px; letter-spacing: 2px; text-transform: uppercase;
  color: var(--muted); margin-right: 4px;
}
.date-btn {
  padding: 5px 14px; font-family: var(--font-mono); font-size: 10px; letter-spacing: 1px;
  border: 1px solid var(--border2); background: var(--surface2); color: var(--muted2);
  cursor: pointer; transition: all 0.12s;
  clip-path: polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);
}
.date-btn:hover { color: var(--text); border-color: var(--muted); }
.date-btn.active { background: rgba(79,255,176,0.1); border-color: var(--accent); color: var(--accent); }
.date-input {
  background: var(--bg); border: 1px solid var(--border2); color: var(--text);
  font-family: var(--font-mono); font-size: 11px; padding: 5px 8px; outline: none;
  transition: border-color 0.15s;
}
.date-input:focus { border-color: var(--accent); }
.date-apply {
  padding: 5px 14px; font-family: var(--font-mono); font-size: 10px; letter-spacing: 1px;
  border: 1px solid var(--accent); background: rgba(79,255,176,0.08); color: var(--accent);
  cursor: pointer; transition: all 0.12s;
}
.date-apply:hover { background: rgba(79,255,176,0.18); }

/* â”€â”€ KPI Grid (8 blocks, 2 rows of 4) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kpi-grid {
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px;
  background: var(--border); border: 1px solid var(--border); margin-bottom: 24px;
}
.kpi-block { background: var(--surface); padding: 18px 20px; }
.kpi-label {
  font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--muted);
  margin-bottom: 8px;
}
.kpi-value {
  font-family: var(--font-display); font-size: 26px; letter-spacing: 1px;
}
.kpi-sub {
  font-size: 10px; color: var(--muted); margin-top: 4px; letter-spacing: 0.5px;
  font-family: var(--font-mono);
}

/* â”€â”€ Calendar Heatmap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cal-container { overflow-x: auto; }
.cal-month {
  display: inline-block; vertical-align: top; margin-right: 24px; margin-bottom: 16px;
}
.cal-month-label {
  font-family: var(--font-display); font-size: 13px; letter-spacing: 2px;
  color: var(--muted2); margin-bottom: 6px;
}
.cal-dow-row {
  display: grid; grid-template-columns: repeat(7, 28px); gap: 3px; margin-bottom: 3px;
}
.cal-dow-label {
  font-size: 8px; letter-spacing: 1px; text-transform: uppercase;
  color: var(--muted); text-align: center;
}
.cal-grid {
  display: grid; grid-template-columns: repeat(7, 28px); gap: 3px;
}
.cal-cell {
  width: 28px; height: 28px; border-radius: 2px; position: relative;
  display: flex; align-items: center; justify-content: center;
  font-size: 8px; font-family: var(--font-mono); color: var(--muted);
  transition: transform 0.1s;
  cursor: default;
}
.cal-cell:hover { transform: scale(1.3); z-index: 2; }
.cal-cell-empty { background: transparent; }
.cal-cell-no-trade { background: var(--surface2); border: 1px solid var(--border); }

/* Calendar tooltip */
.cal-cell .cal-tip {
  display: none; position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%);
  background: #1a1f2e; border: 1px solid #2a3044; border-radius: 3px;
  padding: 6px 10px; white-space: nowrap; z-index: 10;
  font-size: 10px; color: #e8ecf4; pointer-events: none;
}
.cal-cell:hover .cal-tip { display: block; }

/* Cal legend */
.cal-legend {
  display: flex; align-items: center; gap: 6px; margin-top: 12px;
  font-size: 9px; color: var(--muted); letter-spacing: 1px;
}
.cal-legend-swatch {
  width: 14px; height: 14px; border-radius: 2px; border: 1px solid var(--border);
}

/* â”€â”€ Pre-trade patience wheel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.patience-wrap {
  display: flex; align-items: center; gap: 32px;
}
.patience-donut-box {
  position: relative; width: 220px; height: 220px; flex-shrink: 0;
}
.patience-legend { flex: 1; display: flex; flex-direction: column; gap: 8px; }
.legend-row {
  display: flex; align-items: center; gap: 10px;
  font-family: var(--font-mono); font-size: 11px;
}
.legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.legend-tag { color: var(--text); flex: 1; }
.legend-pct { color: var(--muted2); font-size: 10px; min-width: 36px; text-align: right; }
.legend-count { color: var(--muted); font-size: 10px; min-width: 28px; text-align: right; }
.patience-center-label {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
  text-align: center; pointer-events: none;
}
.patience-center-pct  { font-family: var(--font-display); font-size: 28px; color: var(--accent); }
.patience-center-sub  { font-size: 9px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; }

/* â”€â”€ Tag table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tag-filter-row { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 18px; }
.filter-btn {
  padding: 4px 12px; font-family: var(--font-mono); font-size: 10px; letter-spacing: 1px;
  border: 1px solid var(--border2); background: var(--surface2); color: var(--muted2);
  cursor: pointer; transition: all 0.12s;
  clip-path: polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);
}
.filter-btn:hover  { color:var(--text); border-color:var(--muted); }
.filter-btn.active { background:rgba(79,255,176,0.1); border-color:var(--accent); color:var(--accent); }

.no-data { text-align:center; padding:60px 20px; color:var(--muted); }
.no-data-icon { font-size:36px; margin-bottom:12px; opacity:0.3; }

/* Min sample warning */
.min-sample-msg {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  height: 180px; gap: 10px; color: var(--muted);
}
.min-sample-icon { font-size: 28px; opacity: 0.35; }
.min-sample-text { font-size: 11px; letter-spacing: 0.5px; text-align: center; line-height: 1.6; }
.min-sample-count {
  font-family: var(--font-mono); font-size: 10px;
  color: var(--border2); letter-spacing: 1px;
}

/* â”€â”€ Streak card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.streak-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px; }
.streak-stat {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 2px; padding: 14px 16px; text-align: center;
}
.streak-stat-label { font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
.streak-stat-val   { font-family: var(--font-display); font-size: 28px; letter-spacing: 2px; }
.streak-current-W  { color: var(--green); }
.streak-current-L  { color: var(--red); }
.streak-current-B  { color: var(--muted2); }

.streak-sparkline { display: flex; gap: 3px; align-items: flex-end; flex-wrap: wrap; }
.spark-label { font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
.spark-dot {
  width: 18px; height: 18px; border-radius: 2px; display: flex;
  align-items: center; justify-content: center;
  font-size: 9px; font-weight: 700; font-family: var(--font-mono);
}
.spark-W { background: rgba(79,255,176,0.2);  color: var(--green); border: 1px solid rgba(79,255,176,0.4); }
.spark-L { background: rgba(255,77,109,0.2);  color: var(--red);   border: 1px solid rgba(255,77,109,0.4); }
.spark-B { background: rgba(138,150,170,0.15);color: var(--muted); border: 1px solid var(--border); }
{% endblock %}

{% block content %}

<!-- â”€â”€ Page Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div style="display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:28px;">
  <div>
    <div class="page-title">Analytics</div>
    <div class="page-sub">KPIs Â· Equity Curve Â· Calendar Â· Tag Performance</div>
  </div>
</div>

<!-- â”€â”€ Date Range Filter Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="date-filter-bar">
  <span class="date-filter-label">Period</span>
  <button class="date-btn {{ 'active' if date_preset == 'all' }}" onclick="setPreset('all')">All Time</button>
  <button class="date-btn {{ 'active' if date_preset == 'week' }}" onclick="setPreset('week')">This Week</button>
  <button class="date-btn {{ 'active' if date_preset == 'month' }}" onclick="setPreset('month')">This Month</button>
  <button class="date-btn {{ 'active' if date_preset == '30d' }}" onclick="setPreset('30d')">Last 30 Days</button>
  <button class="date-btn {{ 'active' if date_preset == '90d' }}" onclick="setPreset('90d')">Last 90 Days</button>
  <span style="color:var(--border2);margin:0 4px;">|</span>
  <span class="date-filter-label">Custom</span>
  <input type="date" class="date-input" id="df-from" value="{{ date_from }}">
  <span style="color:var(--muted);font-size:10px;">to</span>
  <input type="date" class="date-input" id="df-to" value="{{ date_to }}">
  <button class="date-apply" onclick="applyCustom()">Apply</button>
</div>

{% if data.overall and data.overall.total_trades %}

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  SECTION 1: KEY PERFORMANCE INDICATORS                                    -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div class="kpi-grid">
  <div class="kpi-block">
    <div class="kpi-label">Total Trades</div>
    <div class="kpi-value">{{ data.overall.total_trades }}</div>
    <div class="kpi-sub">{{ data.overall.total_days or 0 }} trading days</div>
  </div>
  <div class="kpi-block">
    <div class="kpi-label">Win Rate</div>
    {% set wr = (data.overall.wins / data.overall.total_trades * 100)|round|int %}
    <div class="kpi-value {{ 'pnl-pos' if wr >= 50 else 'pnl-neg' }}">{{ wr }}%</div>
    <div class="kpi-sub">{{ data.overall.wins }} / {{ data.overall.total_trades }} trades</div>
  </div>
  <div class="kpi-block">
    <div class="kpi-label">Net P&L</div>
    {% set tp = data.overall.total_pnl or 0 %}
    <div class="kpi-value {{ 'pnl-pos' if tp >= 0 else 'pnl-neg' }}">
      {{ '+' if tp >= 0 else '' }}${{ '%.2f'|format(tp) }}
    </div>
    <div class="kpi-sub">
      {% if data.overall.profit_factor is defined and data.overall.profit_factor %}
        Profit Factor: {{ data.overall.profit_factor }}
      {% endif %}
    </div>
  </div>
  <div class="kpi-block">
    <div class="kpi-label">Avg P&L / Trade</div>
    {% set ap = data.overall.avg_pnl or 0 %}
    <div class="kpi-value {{ 'pnl-pos' if ap >= 0 else 'pnl-neg' }}">
      {{ '+' if ap >= 0 else '' }}${{ '%.2f'|format(ap) }}
    </div>
  </div>
  <div class="kpi-block">
    <div class="kpi-label">Avg Win</div>
    {% set aw = data.overall.avg_win or 0 %}
    <div class="kpi-value pnl-pos">+${{ '%.2f'|format(aw) }}</div>
  </div>
  <div class="kpi-block">
    <div class="kpi-label">Avg Loss</div>
    {% set al = data.overall.avg_loss or 0 %}
    <div class="kpi-value pnl-neg">${{ '%.2f'|format(al) }}</div>
    <div class="kpi-sub">
      {% if data.overall.win_loss_ratio is defined %}
        Ratio: {{ data.overall.win_loss_ratio }}
      {% endif %}
    </div>
  </div>
  <div class="kpi-block">
    <div class="kpi-label">Expectancy</div>
    {% set exp = data.overall.expectancy or 0 %}
    <div class="kpi-value {{ 'pnl-pos' if exp >= 0 else 'pnl-neg' }}">
      {{ '+' if exp >= 0 else '' }}${{ '%.2f'|format(exp) }}
    </div>
    <div class="kpi-sub">per trade expected value</div>
  </div>
  <div class="kpi-block">
    <div class="kpi-label">Avg Duration</div>
    {% set dur = data.duration_stats.avg_duration or 0 %}
    <div class="kpi-value">
      {% if dur >= 60 %}
        {{ (dur / 60)|round|int }}h {{ (dur % 60)|round|int }}m
      {% else %}
        {{ dur|round|int }}m
      {% endif %}
    </div>
    <div class="kpi-sub">entry to exit</div>
  </div>
</div>

<!-- Best / Worst quick row -->
<div class="analytics-grid-2" style="margin-bottom:24px;">
  <div class="chart-card" style="padding:14px 20px;display:flex;align-items:center;justify-content:space-between;">
    <div>
      <div class="kpi-label" style="margin:0;">Best Trade</div>
    </div>
    <div class="kpi-value pnl-pos" style="font-size:22px;">+${{ '%.2f'|format(data.overall.best_trade or 0) }}</div>
  </div>
  <div class="chart-card" style="padding:14px 20px;display:flex;align-items:center;justify-content:space-between;">
    <div>
      <div class="kpi-label" style="margin:0;">Worst Trade</div>
    </div>
    <div class="kpi-value pnl-neg" style="font-size:22px;">${{ '%.2f'|format(data.overall.worst_trade or 0) }}</div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  SECTION 2: EQUITY CURVE & DRAWDOWN                                       -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div class="section-divider">Equity & Risk</div>

<div class="chart-card" style="margin-bottom:20px;">
  <div class="chart-title">Equity Curve</div>
  <div class="chart-sub">Cumulative P&L across all trades</div>
  <div class="chart-box chart-box-300"><canvas id="chart-equity"></canvas></div>
</div>

<div class="analytics-grid-2">
  <div class="chart-card">
    <div class="chart-title">Drawdown</div>
    <div class="chart-sub">
      Max drawdown: ${{ '%.2f'|format(data.drawdown.max_dd) }}
      {% if data.drawdown.max_dd_start %}
        ({{ data.drawdown.max_dd_start }} â†’ {{ data.drawdown.max_dd_end }})
      {% endif %}
    </div>
    <div class="chart-box chart-box-220"><canvas id="chart-drawdown"></canvas></div>
  </div>
  <div class="chart-card">
    <div class="chart-title">Daily P&L</div>
    <div class="chart-sub">Net per trading day</div>
    <div class="chart-box chart-box-220"><canvas id="chart-daily"></canvas></div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  SECTION 3: CALENDAR HEATMAP                                              -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div class="section-divider">Calendar</div>

<div class="chart-card" style="margin-bottom:20px;">
  <div class="chart-title">Trading Calendar</div>
  <div class="chart-sub">Daily P&L heatmap â€” green = profit, red = loss</div>
  <div class="cal-container" id="cal-heatmap"></div>
  <div class="cal-legend">
    <span>Loss</span>
    <div class="cal-legend-swatch" style="background:rgba(255,77,109,0.7);"></div>
    <div class="cal-legend-swatch" style="background:rgba(255,77,109,0.35);"></div>
    <div class="cal-legend-swatch" style="background:var(--surface2);"></div>
    <div class="cal-legend-swatch" style="background:rgba(79,255,176,0.35);"></div>
    <div class="cal-legend-swatch" style="background:rgba(79,255,176,0.7);"></div>
    <span>Profit</span>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  SECTION 4: TIME & DURATION ANALYSIS                                      -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div class="section-divider">Time & Duration</div>

<div class="analytics-grid-2">
  <div class="chart-card">
    <div class="chart-title">Time of Day</div>
    <div class="chart-sub">Avg P&L by entry hour</div>
    <div class="chart-box chart-box-220"><canvas id="chart-time"></canvas></div>
  </div>
  <div class="chart-card">
    <div class="chart-title">Trade Duration vs P&L</div>
    <div class="chart-sub">Hold time (minutes) vs outcome</div>
    <div class="chart-box chart-box-220"><canvas id="chart-duration"></canvas></div>
  </div>
</div>

<div class="analytics-grid-2">
  <div class="chart-card">
    <div class="chart-title">P&L by Day of Week</div>
    <div class="chart-sub">Total net P&L per weekday</div>
    <div class="chart-box chart-box-220"><canvas id="chart-dow"></canvas></div>
  </div>
  <div class="chart-card" id="streak-card">
    <div class="chart-title">Win / Loss Streaks</div>
    <div class="chart-sub">Consecutive trade outcomes</div>
    <div id="streak-content"></div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  SECTION 5: TAG ANALYTICS                                                 -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div class="section-divider">Tag Analytics</div>

<!-- Pre-Trade Patience Wheel -->
{% set pre_tags = data.tag_stats | selectattr('group_id','equalto','pre') | list %}
{% if pre_tags %}
<div class="chart-card" style="margin-bottom:20px;">
  <div class="chart-title">Pre-Trade Mindset</div>
  <div class="chart-sub">Distribution of mental state tags across all tagged trades</div>
  <div class="patience-wrap">
    <div class="patience-donut-box">
      <canvas id="chart-pretrade"></canvas>
      <div class="patience-center-label">
        <div class="patience-center-pct" id="patience-pct">â€”</div>
        <div class="patience-center-sub">patient</div>
      </div>
    </div>
    <div class="patience-legend" id="patience-legend"></div>
  </div>
</div>
{% endif %}

<!-- With Tags + Setup Win Rate -->
<div class="analytics-grid-2">
  <div class="chart-card">
    <div class="chart-title">Avg P&L â€” With Tags</div>
    <div class="chart-sub">When trading with these factors</div>
    <div id="with-wrap">
      <div class="chart-box chart-box-220"><canvas id="chart-with"></canvas></div>
    </div>
  </div>
  <div class="chart-card">
    <div class="chart-title">Win Rate â€” Setup Types</div>
    <div class="chart-sub">% winning trades per setup</div>
    <div id="setup-wrap">
      <div class="chart-box chart-box-260"><canvas id="chart-setup"></canvas></div>
    </div>
  </div>
</div>

<!-- Tag Performance Table -->
<div class="chart-card" style="margin-bottom:24px;">
  <div class="chart-title">Tag Performance Table</div>
  <div class="chart-sub">P&L and win rate by tag group</div>
  <div class="tag-filter-row">
    <button class="filter-btn active" data-group="all"     onclick="filterTable('all')">All</button>
    <button class="filter-btn" data-group="with"    onclick="filterTable('with')">With</button>
    <button class="filter-btn" data-group="against" onclick="filterTable('against')">Against</button>
    <button class="filter-btn" data-group="volume"  onclick="filterTable('volume')">Volume</button>
    <button class="filter-btn" data-group="exit"    onclick="filterTable('exit')">Exit</button>
    <button class="filter-btn" data-group="setup"   onclick="filterTable('setup')">Setup</button>
    <button class="filter-btn" data-group="pre"     onclick="filterTable('pre')">Pre-Trade</button>
  </div>
  <div style="overflow-x:auto;">
    <table class="data-table" id="tag-table">
      <thead>
        <tr>
          <th>Group</th><th>Tag</th><th>Trades</th>
          <th>Wins</th><th>Win Rate</th><th>Avg P&L</th><th>Total P&L</th>
        </tr>
      </thead>
      <tbody>
        {% for row in data.tag_stats %}
        <tr data-group="{{ row.group_id }}">
          <td><span class="tag-chip tag-{{ row.group_id }}">{{ row.group_id }}</span></td>
          <td style="color:var(--text);">{{ row.tag }}</td>
          <td>{{ row.total }}</td>
          <td>{{ row.wins }}</td>
          <td class="{{ 'pnl-pos' if row.win_rate >= 50 else 'pnl-neg' }}">{{ row.win_rate }}%</td>
          <td class="{{ 'pnl-pos' if row.avg_pnl >= 0 else 'pnl-neg' }}">
            {{ '+' if row.avg_pnl >= 0 else '' }}${{ '%.2f'|format(row.avg_pnl) }}
          </td>
          <td class="{{ 'pnl-pos' if row.total_pnl >= 0 else 'pnl-neg' }}">
            {{ '+' if row.total_pnl >= 0 else '' }}${{ '%.2f'|format(row.total_pnl) }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% else %}
<div class="no-data">
  <div class="no-data-icon">ğŸ“Š</div>
  <p>No trade data yet. Import trades or push from Live Trade to see analytics.</p>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATE RANGE FILTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setPreset(preset) {
  const url = new URL(window.location);
  url.searchParams.set('preset', preset);
  url.searchParams.delete('date_from');
  url.searchParams.delete('date_to');
  // Preserve portfolio filter
  window.location.href = url.toString();
}

function applyCustom() {
  const from = document.getElementById('df-from').value;
  const to   = document.getElementById('df-to').value;
  if (!from || !to) return;
  const url = new URL(window.location);
  url.searchParams.set('preset', 'custom');
  url.searchParams.set('date_from', from);
  url.searchParams.set('date_to', to);
  window.location.href = url.toString();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHART.JS SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const RAW = {{ data_json|safe }};

Chart.defaults.color      = '#5a6477';
Chart.defaults.font.family = "'DM Mono', monospace";
Chart.defaults.font.size   = 11;

const gridColor  = 'rgba(42,48,68,0.9)';
const tickColor  = '#4a5568';
const labelColor = '#8a96aa';

const xyScales = {
  x: { grid: { color: gridColor }, ticks: { color: tickColor } },
  y: { grid: { color: gridColor }, ticks: { color: tickColor } }
};

const base = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: { legend: { display: false } },
  scales: xyScales,
};

const tooltipStyle = {
  backgroundColor: '#1a1f2e',
  borderColor: '#2a3044',
  borderWidth: 1,
  titleColor: '#8a96aa',
  bodyColor: '#e8ecf4',
};


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EQUITY CURVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if (RAW.equity_curve && RAW.equity_curve.length) {
  const ec = RAW.equity_curve;
  const labels = ec.map((p, i) => {
    // Show date on first trade of each day
    if (i === 0 || ec[i-1].date !== p.date) return p.date.slice(5);
    return p.time;
  });
  const cumData = ec.map(p => p.cumulative);
  const finalPnl = cumData[cumData.length - 1];

  // Color based on final equity
  const lineColor = finalPnl >= 0 ? '#4fffb0' : '#ff4d6d';

  new Chart(document.getElementById('chart-equity'), {
    type: 'line',
    data: {
      labels,
      datasets: [{
        data: cumData,
        borderColor: lineColor,
        backgroundColor: lineColor + '15',
        fill: true,
        tension: 0.3,
        pointRadius: ec.length > 80 ? 0 : 2,
        pointHoverRadius: 4,
        pointBackgroundColor: lineColor,
        borderWidth: 2,
      }]
    },
    options: {
      ...base,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        ...base.plugins,
        tooltip: {
          ...tooltipStyle,
          callbacks: {
            title: ctx => {
              const idx = ctx[0].dataIndex;
              return `${ec[idx].date}  ${ec[idx].time}`;
            },
            label: ctx => {
              const idx = ctx.dataIndex;
              return [
                ` Cumulative: $${ctx.parsed.y.toFixed(2)}`,
                ` Trade P&L:  $${ec[idx].pnl.toFixed(2)}`
              ];
            }
          }
        }
      },
      scales: {
        x: { ...xyScales.x, ticks: { color: tickColor, maxRotation: 45, maxTicksLimit: 20 } },
        y: { ...xyScales.y, ticks: { color: tickColor, callback: v => '$'+v } }
      }
    }
  });
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAWDOWN CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if (RAW.drawdown && RAW.drawdown.series && RAW.drawdown.series.length) {
  const dd = RAW.drawdown.series;
  const labels = dd.map((p, i) => {
    if (i === 0 || dd[i-1].date !== p.date) return p.date.slice(5);
    return '';
  });

  new Chart(document.getElementById('chart-drawdown'), {
    type: 'line',
    data: {
      labels,
      datasets: [{
        data: dd.map(p => -p.drawdown),  // negative for visual
        borderColor: '#ff4d6d',
        backgroundColor: 'rgba(255,77,109,0.15)',
        fill: true,
        tension: 0.3,
        pointRadius: 0,
        pointHoverRadius: 3,
        borderWidth: 1.5,
      }]
    },
    options: {
      ...base,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        ...base.plugins,
        tooltip: {
          ...tooltipStyle,
          callbacks: {
            title: ctx => {
              const idx = ctx[0].dataIndex;
              return `${dd[idx].date}  ${dd[idx].time}`;
            },
            label: ctx => ` Drawdown: -$${Math.abs(ctx.parsed.y).toFixed(2)}`
          }
        }
      },
      scales: {
        x: { ...xyScales.x, ticks: { color: tickColor, maxRotation: 45, maxTicksLimit: 12 } },
        y: { ...xyScales.y, ticks: { color: tickColor, callback: v => '$'+v } }
      }
    }
  });
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DAILY P&L
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if (RAW.daily && RAW.daily.length) {
  new Chart(document.getElementById('chart-daily'), {
    type: 'bar',
    data: {
      labels: RAW.daily.map(d => d.date.slice(5)),
      datasets: [{
        data: RAW.daily.map(d => d.pnl),
        backgroundColor: RAW.daily.map(d => d.pnl >= 0 ? 'rgba(79,255,176,0.55)' : 'rgba(255,77,109,0.55)'),
        borderColor:     RAW.daily.map(d => d.pnl >= 0 ? '#4fffb0' : '#ff4d6d'),
        borderWidth: 1, borderRadius: 2,
      }]
    },
    options: {
      ...base,
      plugins: {
        ...base.plugins,
        tooltip: {
          ...tooltipStyle,
          callbacks: { label: ctx => ` $${ctx.parsed.y.toFixed(2)}` }
        }
      },
      scales: {
        x: { ...xyScales.x, ticks: { color: tickColor, maxRotation: 45 } },
        y: { ...xyScales.y, ticks: { color: tickColor, callback: v => '$'+v } }
      }
    }
  });
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CALENDAR HEATMAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(function() {
  const container = document.getElementById('cal-heatmap');
  if (!container || !RAW.calendar || !RAW.calendar.length) return;

  // Build dateâ†’pnl map
  const pnlMap = {};
  let maxAbsPnl = 0;
  RAW.calendar.forEach(d => {
    pnlMap[d.date] = d;
    const abs = Math.abs(d.pnl);
    if (abs > maxAbsPnl) maxAbsPnl = abs;
  });

  // Get month range from data
  const dates = RAW.calendar.map(d => d.date).sort();
  const firstDate = new Date(dates[0] + 'T00:00:00');
  const lastDate  = new Date(dates[dates.length - 1] + 'T00:00:00');

  // Iterate each month
  let cur = new Date(firstDate.getFullYear(), firstDate.getMonth(), 1);
  const end = new Date(lastDate.getFullYear(), lastDate.getMonth() + 1, 0);

  while (cur <= end) {
    const year = cur.getFullYear();
    const month = cur.getMonth();
    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    const monthDiv = document.createElement('div');
    monthDiv.className = 'cal-month';

    // Month label
    const label = document.createElement('div');
    label.className = 'cal-month-label';
    label.textContent = `${monthNames[month]} ${year}`;
    monthDiv.appendChild(label);

    // DOW headers
    const dowRow = document.createElement('div');
    dowRow.className = 'cal-dow-row';
    ['S','M','T','W','T','F','S'].forEach(d => {
      const dEl = document.createElement('div');
      dEl.className = 'cal-dow-label';
      dEl.textContent = d;
      dowRow.appendChild(dEl);
    });
    monthDiv.appendChild(dowRow);

    // Calendar grid
    const grid = document.createElement('div');
    grid.className = 'cal-grid';

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Empty cells for padding
    for (let i = 0; i < firstDay; i++) {
      const empty = document.createElement('div');
      empty.className = 'cal-cell cal-cell-empty';
      grid.appendChild(empty);
    }

    // Day cells
    for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      const cell = document.createElement('div');
      cell.className = 'cal-cell';
      cell.textContent = day;

      const data = pnlMap[dateStr];
      if (data) {
        const intensity = maxAbsPnl ? Math.min(Math.abs(data.pnl) / maxAbsPnl, 1) : 0;
        const alpha = 0.15 + intensity * 0.65;
        if (data.pnl > 0) {
          cell.style.background = `rgba(79,255,176,${alpha})`;
          cell.style.color = '#4fffb0';
          cell.style.border = '1px solid rgba(79,255,176,0.4)';
        } else if (data.pnl < 0) {
          cell.style.background = `rgba(255,77,109,${alpha})`;
          cell.style.color = '#ff4d6d';
          cell.style.border = '1px solid rgba(255,77,109,0.4)';
        } else {
          cell.className += ' cal-cell-no-trade';
          cell.style.color = 'var(--muted2)';
        }
        // Tooltip
        const tip = document.createElement('div');
        tip.className = 'cal-tip';
        const sign = data.pnl >= 0 ? '+' : '';
        tip.innerHTML = `<strong>${dateStr}</strong><br>${sign}$${data.pnl.toFixed(2)} Â· ${data.trades} trades Â· ${data.wins}W`;
        cell.appendChild(tip);
      } else {
        cell.className += ' cal-cell-no-trade';
      }

      grid.appendChild(cell);
    }

    monthDiv.appendChild(grid);
    container.appendChild(monthDiv);

    // Next month
    cur = new Date(year, month + 1, 1);
  }
})();


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TIME OF DAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if (RAW.time_stats && RAW.time_stats.length) {
  new Chart(document.getElementById('chart-time'), {
    type: 'bar',
    data: {
      labels: RAW.time_stats.map(t => t.hour + ':00'),
      datasets: [{
        data: RAW.time_stats.map(t => t.avg_pnl),
        backgroundColor: RAW.time_stats.map(t => t.avg_pnl >= 0 ? 'rgba(0,207,255,0.5)' : 'rgba(255,77,109,0.5)'),
        borderColor:     RAW.time_stats.map(t => t.avg_pnl >= 0 ? '#00cfff' : '#ff4d6d'),
        borderWidth: 1, borderRadius: 2,
      }]
    },
    options: {
      ...base,
      plugins: {
        ...base.plugins,
        tooltip: {
          ...tooltipStyle,
          callbacks: {
            label: ctx => {
              const t = RAW.time_stats[ctx.dataIndex];
              return [` Avg P&L: $${t.avg_pnl.toFixed(2)}`, ` Trades: ${t.total}`];
            }
          }
        }
      },
      scales: {
        x: { ...xyScales.x },
        y: { ...xyScales.y, ticks: { color: tickColor, callback: v => '$'+v } }
      }
    }
  });
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRADE DURATION SCATTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if (RAW.duration_stats && RAW.duration_stats.trades && RAW.duration_stats.trades.length) {
  const durTrades = RAW.duration_stats.trades;

  // Separate wins and losses for different colors
  const wins   = durTrades.filter(t => t.pnl > 0).map(t => ({ x: t.duration_mins, y: t.pnl }));
  const losses = durTrades.filter(t => t.pnl < 0).map(t => ({ x: t.duration_mins, y: t.pnl }));
  const be     = durTrades.filter(t => t.pnl === 0).map(t => ({ x: t.duration_mins, y: t.pnl }));

  new Chart(document.getElementById('chart-duration'), {
    type: 'scatter',
    data: {
      datasets: [
        {
          label: 'Wins',
          data: wins,
          backgroundColor: 'rgba(79,255,176,0.5)',
          borderColor: '#4fffb0',
          pointRadius: 5,
          pointHoverRadius: 7,
        },
        {
          label: 'Losses',
          data: losses,
          backgroundColor: 'rgba(255,77,109,0.5)',
          borderColor: '#ff4d6d',
          pointRadius: 5,
          pointHoverRadius: 7,
        },
        {
          label: 'Breakeven',
          data: be,
          backgroundColor: 'rgba(138,150,170,0.4)',
          borderColor: '#8a96aa',
          pointRadius: 4,
          pointHoverRadius: 6,
        }
      ]
    },
    options: {
      ...base,
      plugins: {
        legend: { display: true, labels: { color: labelColor, font: { size: 10 }, boxWidth: 10, padding: 12 } },
        tooltip: {
          ...tooltipStyle,
          callbacks: {
            label: ctx => ` ${ctx.parsed.x.toFixed(0)}min â†’ $${ctx.parsed.y.toFixed(2)}`
          }
        }
      },
      scales: {
        x: { ...xyScales.x, title: { display: true, text: 'Duration (min)', color: labelColor, font: { size: 10 } },
             ticks: { color: tickColor, callback: v => v + 'm' } },
        y: { ...xyScales.y, title: { display: true, text: 'P&L ($)', color: labelColor, font: { size: 10 } },
             ticks: { color: tickColor, callback: v => '$'+v } }
      }
    }
  });
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DAY OF WEEK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const DOW_NAMES = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
if (RAW.dow_stats && RAW.dow_stats.length) {
  const dowMap = {};
  RAW.dow_stats.forEach(d => dowMap[d.dow] = d);
  const tradingDays = [1,2,3,4,5];
  const dowLabels = tradingDays.map(d => DOW_NAMES[d]);
  const dowPnl    = tradingDays.map(d => dowMap[d] ? dowMap[d].total_pnl : 0);
  const dowCount  = tradingDays.map(d => dowMap[d] ? dowMap[d].total : 0);

  new Chart(document.getElementById('chart-dow'), {
    type: 'bar',
    data: {
      labels: dowLabels,
      datasets: [{
        label: 'Net P&L',
        data: dowPnl,
        backgroundColor: dowPnl.map(v => v >= 0 ? 'rgba(79,255,176,0.55)' : 'rgba(255,77,109,0.55)'),
        borderColor:     dowPnl.map(v => v >= 0 ? '#4fffb0' : '#ff4d6d'),
        borderWidth: 1, borderRadius: 3,
      }]
    },
    options: {
      ...base,
      plugins: {
        ...base.plugins,
        tooltip: {
          ...tooltipStyle,
          callbacks: {
            label: ctx => {
              const idx = ctx.dataIndex;
              return [` Net P&L: $${ctx.parsed.y.toFixed(2)}`, ` Trades:  ${dowCount[idx]}`];
            }
          }
        }
      },
      scales: {
        x: { ...xyScales.x },
        y: { ...xyScales.y, ticks: { color: tickColor, callback: v => '$'+v } }
      }
    }
  });
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WIN/LOSS STREAKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(function() {
  const el = document.getElementById('streak-content');
  if (!el || !RAW.streaks) return;
  const s = RAW.streaks;

  const curLabel = s.current_type === 'W' ? 'Win Streak'
                 : s.current_type === 'L' ? 'Loss Streak'
                 : 'Breakeven';
  const curClass = `streak-current-${s.current_type || 'B'}`;
  const curSign  = s.current_type === 'W' ? '\u25B2' : s.current_type === 'L' ? '\u25BC' : '\u2014';

  el.innerHTML = `
    <div class="streak-grid">
      <div class="streak-stat">
        <div class="streak-stat-label">Current</div>
        <div class="streak-stat-val ${curClass}">${curSign}${s.current}</div>
        <div style="font-size:9px;color:var(--muted);margin-top:4px;letter-spacing:1px;">${curLabel}</div>
      </div>
      <div class="streak-stat">
        <div class="streak-stat-label">Best Win Run</div>
        <div class="streak-stat-val" style="color:var(--green);">${s.best_win}</div>
        <div style="font-size:9px;color:var(--muted);margin-top:4px;letter-spacing:1px;">consecutive</div>
      </div>
      <div class="streak-stat">
        <div class="streak-stat-label">Worst Loss Run</div>
        <div class="streak-stat-val" style="color:var(--red);">${s.worst_loss}</div>
        <div style="font-size:9px;color:var(--muted);margin-top:4px;letter-spacing:1px;">consecutive</div>
      </div>
    </div>
    <div class="spark-label">Last ${s.history.length} trades</div>
    <div class="streak-sparkline">
      ${s.history.map(r => `<div class="spark-dot spark-${r}">${r}</div>`).join('')}
    </div>
  `;
})();


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PRE-TRADE PATIENCE WHEEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(function() {
  const canvas = document.getElementById('chart-pretrade');
  if (!canvas) return;

  const preTags = RAW.tag_stats.filter(t => t.group_id === 'pre');
  if (!preTags.length) return;

  const TAG_COLORS = {
    'Trade came to me':    '#4fffb0',
    'Intuition / Mkt Feel':'#1a9e6a',
    'Not sure about context': '#ff4d6d',
    'Quick Profit Attitude':  '#ffb347',
    'Revenge Mindset':        '#ff6b35',
    'Boredom':                '#c3a6ff',
    'Distracted':             '#ff8c94',
  };
  const FALLBACK_COLORS = ['#8a96aa','#5a6477','#4a5568'];

  const NEGATIVE = new Set([
    'Quick Profit Attitude','Revenge Mindset','Boredom','Distracted','Not sure about context'
  ]);
  const totalTagged  = preTags.reduce((s, t) => s + t.total, 0);
  const patientCount = preTags.filter(t => !NEGATIVE.has(t.tag)).reduce((s, t) => s + t.total, 0);
  const patientPct = totalTagged ? Math.round(patientCount / totalTagged * 100) : 0;

  const sortedTags = [
    ...preTags.filter(t => !NEGATIVE.has(t.tag)),
    ...preTags.filter(t =>  NEGATIVE.has(t.tag)),
  ];

  const labels = sortedTags.map(t => t.tag);
  const values = sortedTags.map(t => t.total);
  const colors = sortedTags.map((t, i) =>
    TAG_COLORS[t.tag] || FALLBACK_COLORS[i % FALLBACK_COLORS.length]
  );

  new Chart(canvas, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: colors.map(c => c + 'cc'),
        borderColor: colors,
        borderWidth: sortedTags.map(t => NEGATIVE.has(t.tag) ? 1 : 2),
        hoverOffset: 8,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      cutout: '68%',
      plugins: {
        legend: { display: false },
        tooltip: {
          ...tooltipStyle,
          callbacks: {
            title: ctx => ctx[0].label,
            label: ctx => {
              const pct = totalTagged ? Math.round(ctx.parsed / totalTagged * 100) : 0;
              const sign = NEGATIVE.has(ctx.label) ? '\u26A0 ' : '\u2713 ';
              return `  ${sign}${ctx.parsed} trades (${pct}%)`;
            }
          }
        }
      }
    }
  });

  // Centre label
  const pctEl = document.getElementById('patience-pct');
  pctEl.textContent = patientPct + '%';
  pctEl.style.color = patientPct >= 60 ? '#4fffb0' : patientPct >= 40 ? '#ffb347' : '#ff4d6d';

  // Legend
  const legendEl = document.getElementById('patience-legend');
  legendEl.innerHTML = '';
  const mkHeader = txt => {
    const h = document.createElement('div');
    h.style.cssText = 'font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin:6px 0 4px;padding-bottom:4px;border-bottom:1px solid var(--border);';
    h.textContent = txt;
    legendEl.appendChild(h);
  };
  mkHeader('Patient');
  sortedTags.forEach((t, i) => {
    if (i === preTags.filter(x => !NEGATIVE.has(x.tag)).length) mkHeader('Needs attention');
    const pct = totalTagged ? Math.round(t.total / totalTagged * 100) : 0;
    const row = document.createElement('div');
    row.className = 'legend-row';
    row.innerHTML = `
      <span class="legend-dot" style="background:${colors[i]};box-shadow:0 0 6px ${colors[i]}50;"></span>
      <span class="legend-tag">${t.tag}</span>
      <span class="legend-pct">${pct}%</span>
      <span class="legend-count">${t.total}\u00D7</span>
    `;
    legendEl.appendChild(row);
  });
})();


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WITH TAGS & SETUP WIN RATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const MIN_SAMPLES = 5;

function showMinSample(wrapperId, qualifiedCount, totalCount) {
  const wrap = document.getElementById(wrapperId);
  if (!wrap) return;
  wrap.innerHTML = `
    <div class="min-sample-msg">
      <div class="min-sample-icon">ğŸ”¬</div>
      <div class="min-sample-text">
        Not enough data yet.<br>Need at least ${MIN_SAMPLES} trades per tag.
      </div>
      <div class="min-sample-count">${qualifiedCount} of ${totalCount} tags have enough data</div>
    </div>`;
}

const withTags = RAW.tag_stats.filter(t => t.group_id === 'with' && t.total >= MIN_SAMPLES);
const withAll  = RAW.tag_stats.filter(t => t.group_id === 'with');
if (withTags.length) {
  new Chart(document.getElementById('chart-with'), {
    type: 'bar',
    data: {
      labels: withTags.map(t => t.tag),
      datasets: [{
        data: withTags.map(t => t.avg_pnl),
        backgroundColor: withTags.map(t => t.avg_pnl >= 0 ? 'rgba(79,255,176,0.55)' : 'rgba(255,77,109,0.55)'),
        borderColor:     withTags.map(t => t.avg_pnl >= 0 ? '#4fffb0' : '#ff4d6d'),
        borderWidth: 1, borderRadius: 2,
      }]
    },
    options: {
      ...base, indexAxis: 'y',
      scales: {
        x: { ...xyScales.x, ticks: { color: tickColor, callback: v => '$'+v } },
        y: { ...xyScales.y, ticks: { color: labelColor, font: { size: 10 } } }
      }
    }
  });
  if (withTags.length < withAll.length) {
    const note = document.createElement('div');
    note.style.cssText = 'font-size:10px;color:var(--muted);letter-spacing:0.5px;margin-top:8px;';
    note.textContent = `Showing ${withTags.length}/${withAll.length} tags with \u2265${MIN_SAMPLES} trades`;
    document.getElementById('with-wrap').appendChild(note);
  }
} else {
  showMinSample('with-wrap', 0, withAll.length);
}

const setupTags = RAW.tag_stats.filter(t => t.group_id === 'setup' && t.total >= MIN_SAMPLES);
const setupAll  = RAW.tag_stats.filter(t => t.group_id === 'setup');
if (setupTags.length) {
  new Chart(document.getElementById('chart-setup'), {
    type: 'bar',
    data: {
      labels: setupTags.map(t => t.tag.length > 22 ? t.tag.slice(0,22)+'\u2026' : t.tag),
      datasets: [{
        data: setupTags.map(t => t.win_rate),
        backgroundColor: setupTags.map(t => t.win_rate >= 50 ? 'rgba(180,127,255,0.55)' : 'rgba(255,77,109,0.45)'),
        borderColor:     setupTags.map(t => t.win_rate >= 50 ? '#b47fff' : '#ff4d6d'),
        borderWidth: 1, borderRadius: 2,
      }]
    },
    options: {
      ...base, indexAxis: 'y',
      scales: {
        x: { min:0, max:100, grid:{color:gridColor}, ticks:{color:tickColor, callback: v => v+'%'} },
        y: { grid:{color:gridColor}, ticks:{color:labelColor, font:{size:10}} }
      }
    }
  });
  if (setupTags.length < setupAll.length) {
    const note = document.createElement('div');
    note.style.cssText = 'font-size:10px;color:var(--muted);letter-spacing:0.5px;margin-top:8px;';
    note.textContent = `Showing ${setupTags.length}/${setupAll.length} tags with \u2265${MIN_SAMPLES} trades`;
    document.getElementById('setup-wrap').appendChild(note);
  }
} else {
  showMinSample('setup-wrap', 0, setupAll.length);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABLE FILTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function filterTable(group) {
  document.querySelectorAll('.filter-btn').forEach(b =>
    b.classList.toggle('active', b.dataset.group === group));
  document.querySelectorAll('#tag-table tbody tr').forEach(row =>
    row.style.display = (group === 'all' || row.dataset.group === group) ? '' : 'none');
}
</script>
{% endblock %}
